<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.plateer.ec1.promotion.mapper.PromotionMapper">
    <select id="getAvailableCouponList" parameterType="com.plateer.ec1.promotion.vo.RequestPromotionVo" resultType="com.plateer.ec1.common.model.promotion.CcCpnBaseModel">
        SELECT ccb.prm_no
                 , ccb.cpn_kind_cd
                 , ccb.degr_ccd
                 , ccb.dc_sv_ccd
                 , ccb.mda_gb
                 , ccb.ent_chn_gb
                 , ccb.dwl_priod_ccd
                 , ccb.dwl_avl_strt_dd
                 , ccb.dwl_avl_end_dd
                 , ccb.dwl_std_dd
                 , ccb.dwl_psb_cnt
                 , ccb.psn_dwl_psb_cnt
                 , ccb.dwl_avl_plc
                 , ccb.iss_way_ccd
                 , ccb.cert_cd
                 , ccb.our_chrg_rt
                 , ccb.entr_chrg_rt
          FROM cc_prm_base cpb
         INNER JOIN cc_cpn_base ccb
            ON cpb.prm_no = ccb.prm_no
<!--        -->
<!--        <if test="@org.springframework.util.ObjectUtils@isEmpty(mbrNo)">-->
<!--         RIGHT OUTER JOIN (SELECT prm_no, COUNT(prm_no) as cnt-->
<!--                       FROM cc_cpn_issue-->
<!--                      GROUP BY prm_no) cci-->
<!--            ON ccb.prm_no = cci.prm_no-->
<!--         WHERE ccb.dwl_psb_cnt > cci.cnt-->
<!--        </if>-->
<!--        -->
        <if test="!@org.springframework.util.ObjectUtils@isEmpty(mbrNo)">
         INNER JOIN (SELECT prm_no, COUNT(prm_no) as cnt
                       FROM cc_cpn_issue
                      WHERE mbr_no = #{mbrNo}
                      GROUP BY prm_no) cci
            ON ccb.prm_no = cci.prm_no
          WHERE ccb.psn_dwl_psb_cnt > cci.cnt
        </if>
    <![CDATA[
           AND ((ccb.dwl_priod_ccd = '10'
                    AND NOW() >= ccb.dwl_avl_strt_dd::date AND NOW() < ccb.dwl_avl_end_dd::date + interval '1 day')
                OR (ccb.dwl_priod_ccd = '20'
                    AND NOW() >= cpb.prm_strt_dt AND NOW() < cpb.prm_strt_dt + (interval '1 day' * ccb.dwl_std_dd) + interval '1 day'))
    ]]>
    </select>
</mapper>