<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.plateer.ec1.promotion.mapper.PromotionMapper">
    <!-- 다운로드 가능 쿠폰 검증 -->
    <select id="getAvailableCouponValidate" parameterType="com.plateer.ec1.promotion.vo.RequestPromotionVo"  resultType="boolean">
        SELECT EXISTS(
            SELECT prm_no
              FROM cc_cpn_base ccb
             WHERE prm_no = '1'
               AND ccb.dwl_psb_cnt > ( SELECT COUNT(1) as cnt
                                         FROM cc_cpn_issue cntA
                                        WHERE cntA.prm_no = ccb.prm_no )
               AND ccb.psn_dwl_psb_cnt > ( SELECT COUNT(1) as cnt
                                             FROM cc_cpn_issue cntM
                                            WHERE cntM.prm_no = ccb.prm_no
                                              AND cntM.mbr_no = 'test01' )
               AND NOW() <![CDATA[>=]]> ccb.dwl_avl_strt_dd::date AND NOW() <![CDATA[<]]> ccb.dwl_avl_end_dd::date + interval '1 day'
        )
    </select>

    <!-- 사용취소를 위해 프로모션 기간 검증 -->
    <select id="getPromotionValidate" parameterType="long"  resultType="boolean">
        SELECT EXISTS (
            SELECT prm_no
              FROM cc_prm_base
             WHERE prm_no = #{prmNo}
               AND NOW() <![CDATA[<]]> cc_prm_base.prm_end_dt + interval '1 day')
    </select>
</mapper>